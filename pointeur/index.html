<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Title</title>
  <script src="https://cdn-tailwindcss.vercel.app/"></script>
</head>
<style>
  main > div {
    display: table-cell;
}

#event-list {
    top: 10px;
    position: relative;
    width: 200px;
    max-width: 200px;
}
</style>
<body class="bg-[lightgrey]">
  <main onload="addmarkerlist()" class="mx-auto my-[100px]">
    <h1>List</h1>
    <div>
      <ul class="listtest" id="tesli"></ul>
      <ul class="vraieliste" id="vraieliste"></ul>
    </div>

    <h1>Map</h1>
  <div id="popup" class="my-[100px] mx-auto w-[70vw] h-[700px] absolute overflow-hidden"></div>
  
    <div id="event-list">
      <ul class="draggable-list" id="draggable-list"></ul>
    </div>
    
    <div
            class="w-[70vw] h-[700px] relative overflow-hidden"
            id="map-container"
    >
      <img
              class="max-w-none select-none absolute filter"
              src="map.png"
              id="map"
              alt="map"
              ondragstart="return false;"
      />
      <div id="pointers"></div>
      <div id="lines"></div>
    </div>
  </main>
  </body>
<script>
  let gMouseDownX = 0;
  let gMouseDownY = 0;
  let gMouseDownOffsetX = 0;
  let gMouseDownOffsetY = 0;

  //let pointers = [{x: 544, y: 144 }, {x: 600, y: 200 }, {x: 700, y: 255 }, {x: 800, y: 355 }, {x: 821, y: 333 }];
  let lines = [];
  let list = [];

  let $map = document.querySelector("#map");
  let $pointers = document.querySelector("#pointers");
  let $popup = document.querySelector("#popup");
  let $lines = document.querySelector("#lines");
  let $ul = document.querySelector("#tesli");
  let $vraieul = document.querySelector("#draggable-list");
  let $mapContainer = document.querySelector("#map-container");
  let $pointer;
  let $line;

  let maxLeft = Math.round($map.width - $mapContainer.offsetWidth) * -1;
  let maxTop = Math.round($map.height - $mapContainer.offsetHeight) * -1;

  let modalOpen = false;
  var pointers = new Array();
  let ordreliste = new Array();
  var markup = '';
  var popup = '';
  var liste = '';
  var jsontext = '';


  function init() {
    $map.addEventListener("mousedown", mouseDown);
    window.addEventListener("mouseup", mouseUp);

    initPointer();
    initLine()
  }

  function addToList(i) {
    list.push(i)
    initLine();
  }

  function initPointer() {
    var ul = document.getElementById("tesli");


    var request = new XMLHttpRequest();

    var array = new Array();
    var oldarray = new Array();

    request.open('POST', 'http://localhost:8000/animation/list', true);

    request.responseType = 'json';


    request.onreadystatechange = chargement;

    request.send();

    function chargement(){
      var txt = '{"animations" :' + JSON.stringify(request.response) + '}';

      var x ;
      var y ;

      const animation = JSON.parse(txt);
      if(animation.animations != null) {
        for (let j = 0; j <= animation.animations.length; j++) {
          if(animation.animations[j] != null) {
            markup = '';
            popup= '';
            liste = '';

            ab = animation.animations[j]._coord__x;
            or = animation.animations[j]._coord__y;
            titre = animation.animations[j].animation_titre;
            lieu = animation.animations[j].animation_lieu;
            photo = animation.animations[j].animation_photo;
            desc = animation.animations[j].animation_description;
            array = [{x : ab, y : or, titre : titre, lieu : lieu, photo : photo, desc : desc}];
            oldarray = oldarray.concat(array);
            //alert(ab +" " + or);
            pointers = oldarray;
            //console.log(pointers);
            //style="width: 44px; height: 44px; user-select: none; border: 0px; padding: 0px; margin: 0px; max-width: none;"
            //draggable="false"
            let i = 0;

            for (var k = 0; k < pointers.length ; k++) {
              titre = pointers[k].titre;

              liste += `<li data-index="${k}" class="listeall hidden">`+titre+`</li>`;

              markup+= `<img id="markup" data-index="${k}" src="marker.svg" class="h-[50px] absolute cursor-pointer pointer z-10" alt="map" style="position: absolute ;left:`+pointers[k].x+`px ; top:`+(pointers[k].y+20)+`px;" onload="hidebutt(), chargerpopup()">`;

              popup += `<div data-index="${k}" class="rounded relative h-[600px] w-[350px] bg-cyan-50 hidden outline outline-offset-2 outline-cyan-500 pointer-modal z-20 p-3 px-4 grid justify-items-center" style="left: 50%; margin-top: 4%">
                      <h2 class="titremarker font-bold text-blue-600 underline decoration-2 flex justify-center">`+pointers[k].titre+`</h2><br>
                      <h6 class="italic flex justify-center underline">`+pointers[k].lieu+`</h6><br>
                      <img class="max-w-[75%] mx-auto" src="`+pointers[k].photo+`"><br>
                      <p class="text-center">`+pointers[k].desc+`</p><br>
                      <button data-index="${k}" id="iti" onclick="addToList(${k}), closeModal()" class="py-1 px-2 uppcaser bg-[blue] text-white rounded-lg additi">Ajouter a l'itinéraire</button>
                        </div>`;
            }

            $pointers.innerHTML = markup;
            $popup.innerHTML = popup;
            $ul.innerHTML = liste;
          }
        }
      }
    }
  }
  //fonction pour enlever la classe "hidden" au bouton
  /*function showbutt(){
    var $list = document.querySelector(`.tesli`);

    $list.forEach((element)=>{
      element.addEventListener("click", (e)=>{
        document.querySelector(`.additi[data-index="${e.currentTarget.dataset.index}"]`).classList.remove("hidden");
      });
    });

  }*/


  function contenulist(){
    var $markerbutton = document.querySelectorAll("#iti");
    var $marker = document.querySelectorAll("#markup");

    var compteur = 0;

    $markerbutton.forEach((element)=>{

      element.addEventListener("click", (e)=>{
        titreMarker = document.querySelector(`.listeall[data-index="${e.currentTarget.dataset.index}"]`).innerHTML;
        idMarker = document.querySelector(`.listeall[data-index="${e.currentTarget.dataset.index}"]`).dataset.index;
        xMarker = document.querySelector(`.pointer[data-index="${e.currentTarget.dataset.index}"]`).style.getPropertyValue("left");
        yMarker = document.querySelector(`.pointer[data-index="${e.currentTarget.dataset.index}"]`).style.getPropertyValue("top");
        premierli = [{num_ordre:compteur,id_anim:idMarker,titre_anim:titreMarker,x:xMarker,y:yMarker}];
        ordreliste = ordreliste.concat(premierli);

        addElementPointerList(compteur, ordreliste[compteur]);

        compteur++;
      });

    });
  }

  function hidebutt(){
    premierpointeur = document.querySelector(`.pointer[data-index="1"]`);

    premierpointeur.setAttribute("onload", "contenulist(),hidebutt(), chargerpopup()");

    var contenueUL = document.querySelector(".listtest").innerHTML;
    var $button = document.querySelectorAll("#iti");
    $button.forEach((element)=>{
      element.addEventListener("click", (e)=>{
        document.querySelector(`.additi[data-index="${e.currentTarget.dataset.index}"]`).classList.add("hidden");
        /*contenueLI = document.querySelector(`.listeall[data-index="${e.currentTarget.dataset.index}"]`).innerHTML;
        console.log(contenueLI);
        $ul.append(contenueLI);*/
      });
    });

  }

  function chargerpopup(){
    $pointer = $pointers.querySelectorAll(".pointer");

    $pointer.forEach((element) => {
      /*element.style.left = `${pointers[element.dataset.index].x}px`
      element.style.top = `${pointers[element.dataset.index].y}px`*/
      //alert("entré");
      element.addEventListener("click", (e) => {
        if (modalOpen)
          closeModal()
        e.stopImmediatePropagation();
        document.querySelector(`.pointer-modal[data-index="${e.currentTarget.dataset.index}"]`).classList.remove("hidden");
        $map.classList.add("brightness-50");
        $pointer.forEach(element => element.classList.add("brightness-50"))
        $line.forEach(element => element.classList.add("brightness-50"))
        modalOpen = true;
      });
      let $pointerModal = document.querySelectorAll(".pointer-modal");
      $pointerModal.forEach((element) => {
        //element.style.left = `${pointers[element.dataset.index].x + 25}px`
        //element.style.top = `${pointers[element.dataset.index].y - 150}px`
      })
    })

    $mapContainer.addEventListener("click", closeModal);
  }

  function initLine() {
    let markup = ''
    let start = 0
    let end = 1
    if (list.length > 1) {
      for (let i = 0; i < list.length - 1; i++) {
        lines.push({start: list[start], end: list[end]})
        start++
        end++
      }
    }
    lines.forEach(element => {
      let start = pointers[element.start]
      let end = pointers[element.end]

      markup += `<svg class="absolute pointer-events-none z-10" width="100%" height="100%"><line class="line" data-start="${element.start}" data-end="${element.end}" x1="${start.x + 25}" y1="${start.y + 50}" x2="${end.x + 25}" y2="${end.y + 50}" stroke="red" stroke-width="3"/></svg>`
    })

    $lines.innerHTML = markup

    $line = $lines.querySelectorAll(".line");
  }

  function closeModal() {
    if (modalOpen) {
      document.querySelectorAll('.pointer-modal').forEach(element => {
        if (!element.classList.contains('hidden'))
          element.classList.add("hidden")
      })
      $map.classList.remove("brightness-50");
      $pointer.forEach(element => element.classList.remove("brightness-50"))
      $line.forEach(element => element.classList.remove("brightness-50"))
      modalOpen = false;
    }
  }

  function mouseUp() {
    $map.style.cursor = "auto";
    window.removeEventListener("mousemove", divMove);
  }

  function mouseDown(e) {
    if (!modalOpen) {
      gMouseDownX = e.clientX;
      gMouseDownY = e.clientY;

      //The following block gets the X offset (the difference between where it starts and where it was clicked)
      let leftPart = "";
      if (!$map.style.left) leftPart += "0px";
      //In case this was not defined as 0px explicitly.
      else leftPart = $map.style.left;
      let leftPos = leftPart.indexOf("px");
      let leftNumString = leftPart.slice(0, leftPos); // Get the X value of the object.
      gMouseDownOffsetX = gMouseDownX - parseInt(leftNumString, 10);

      //The following block gets the Y offset (the difference between where it starts and where it was clicked)
      let topPart = "";
      if (!$map.style.top) topPart += "0px";
      //In case this was not defined as 0px explicitly.
      else topPart = $map.style.top;
      let topPos = topPart.indexOf("px");
      let topNumString = topPart.slice(0, topPos); // Get the Y value of the object.
      gMouseDownOffsetY = gMouseDownY - parseInt(topNumString, 10);

      window.addEventListener("mousemove", divMove);
    }
  }

  function divMove(e) {
    $map.style.cursor = "move";
    let topAmount = e.clientY - gMouseDownOffsetY;
    if (topAmount <= 0 && topAmount >= maxTop) {
      $map.style.top = topAmount + "px";
      $pointer.forEach(pointer => {
        pointer.style.top = `${pointers[pointer.dataset.index].y + topAmount}px`;
        //document.querySelector(`.pointer-modal[data-index="${pointer.dataset.index}"]`).style.top = `${pointers[pointer.dataset.index].y + topAmount - 150}px`;
        $line.forEach(line => {
          if (line.dataset.start === pointer.dataset.index)
            line.setAttribute('y1', pointers[pointer.dataset.index].y + topAmount + 50)
          if (line.dataset.end === pointer.dataset.index)
            line.setAttribute('y2' , pointers[pointer.dataset.index].y + topAmount + 50)
        })
      })
    }
    let leftAmount = e.clientX - gMouseDownOffsetX;
    if (leftAmount <= 0 && leftAmount >= maxLeft) {
      $map.style.left = leftAmount + "px";
      $pointer.forEach(pointer => {
        pointer.style.left = `${pointers[pointer.dataset.index].x + leftAmount}px`;
        //document.querySelector(`.pointer-modal[data-index="${pointer.dataset.index}"]`).style.left = `${pointers[pointer.dataset.index].x + leftAmount + 25}px`;
        $line.forEach(line => {
          if (line.dataset.start === pointer.dataset.index)
            line.setAttribute('x1', pointers[pointer.dataset.index].x + leftAmount + 25)
          if (line.dataset.end === pointer.dataset.index)
            line.setAttribute('x2', pointers[pointer.dataset.index].x + leftAmount + 25)
        })
      })
    }
  }

  init();

  /***** *****/
  
  let choosedpointers = [];

  let dragStartIndex;

  createList();

  // Insert list items into DOM
  function createList() {
     /* choosedpointers
      .sort((a, b) => a.num_ordre - b.num_ordre)
      .forEach(e => {
          const listItem = document.createElement('li');

          listItem.setAttribute('data-index', e.num_ordre);
    
          listItem.innerHTML = `
            <div class="draggable" draggable="true">
              <p class="person-name">${e.title}</p>
              <i class="fas fa-grip-lines"></i>
            </div>
          `;
    
          listItems.push(listItem);
    
          draggable_list.appendChild(listItem);
      })
  [...prod]
      .map(a => ({ value: a, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(a => a.value)
      .forEach((person, index) => {
        const listItem = document.createElement('li');

        listItem.setAttribute('data-index', index);

        listItem.innerHTML = `
          <span class="number">${index + 1}</span>
          <div class="draggable" draggable="true">
            <p class="person-name">${person}</p>
            <i class="fas fa-grip-lines"></i>
          </div>
        `;

        listItems.push(listItem);

        draggable_list.appendChild(listItem);
      }); */
  }

  function addElementPointerList(index, pointer) {
      const listItem = document.createElement('li');

      listItem.setAttribute('data-index', index);

      listItem.innerHTML = `
        <span class="number">${index}</span>
        <div class="draggable" draggable="true">
          <p class="person-name">${pointer.titre_anim}</p>
          <i class="fas fa-grip-lines"></i>
        </div>
      `;

      choosedpointers.push(pointer)

      $vraieul.appendChild(listItem);

      addEventListenersSpecific(listItem, listItem.getElementsByClassName("draggable")[0])
  }


  function dragStart() {
    console.log('Event: ', 'dragstart');
    dragStartIndex = +this.closest('li').getAttribute('data-index');
  }

  function dragEnter() {
    console.log('Event: ', 'dragenter');
    this.classList.add('over');
  }

  function dragLeave() {
    console.log('Event: ', 'dragleave');
    this.classList.remove('over');
  }

  function dragOver(e) {
    console.log('Event: ', 'dragover');
    e.preventDefault();
  }

  function dragDrop() {
    console.log('Event: ', 'drop');
    const dragEndIndex = +this.getAttribute('data-index');
    swapItems(dragStartIndex, dragEndIndex);

    this.classList.remove('over');
  }

  // Swap list items that are drag and drop
  function swapItems(fromIndex, toIndex) {
    const itemOne = document.querySelector('#draggable-list li[data-index="'+fromIndex+'"]');
    const itemOneSAVE = itemOne.querySelector("div")

    const itemTwo = document.querySelector('#draggable-list li[data-index="'+toIndex+'"]');

    itemOne.appendChild(itemTwo.querySelector("div"));
    itemTwo.appendChild(itemOneSAVE);

    choosedpointers[fromIndex].num_ordre = toIndex
    choosedpointers[toIndex].num_ordre = fromIndex
  }


  function addEventListenersSpecific(li, draggable) {
    draggable.addEventListener('dragstart', dragStart);

    li.addEventListener('dragover', dragOver);
    li.addEventListener('drop', dragDrop);
    li.addEventListener('dragenter', dragEnter);
    li.addEventListener('dragleave', dragLeave);
  }

  function addEventListenersAllDraggable() {
    const draggables = document.querySelectorAll('.draggable');
    const dragListItems = document.querySelectorAll('.draggable-list li');

    draggables.forEach(draggable => {
      draggable.addEventListener('dragstart', dragStart);
    });

    dragListItems.forEach(item => {
      item.addEventListener('dragover', dragOver);
      item.addEventListener('drop', dragDrop);
      item.addEventListener('dragenter', dragEnter);
      item.addEventListener('dragleave', dragLeave);
    });
  }

</script>
</html>
